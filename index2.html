<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¸…æ½”å…¬å¸ - æ™ºèƒ½å¹´å‡ç®¡ç†ç³»çµ± V4.0</title>
    <!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --bg-color: #f4f7f6;
            --sidebar-width: 240px;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', "Microsoft JhengHei", sans-serif; }
        body { display: flex; background-color: var(--bg-color); height: 100vh; overflow: hidden; }

        /* --- å´é‚Šæ¬„ --- */
        .sidebar { width: var(--sidebar-width); background-color: var(--primary-color); color: white; display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; }
        .sidebar h2 { margin-bottom: 30px; font-size: 1.4rem; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px; }
        .menu-item { padding: 15px; cursor: pointer; border-radius: 5px; margin-bottom: 10px; display: flex; align-items: center; gap: 10px; transition: 0.3s; }
        .menu-item:hover, .menu-item.active { background-color: var(--secondary-color); }

        /* --- ä¸»å…§å®¹ --- */
        .main-content { flex: 1; padding: 20px; display: flex; flex-direction: column; overflow-y: auto; }
        .section { display: none; height: 100%; flex-direction: column; }
        .section.active { display: flex; }

        /* --- å„€è¡¨æ¿å¡ç‰‡ --- */
        .card-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); text-align: center; border-left: 5px solid var(--secondary-color); }
        .card h3 { font-size: 2rem; color: var(--primary-color); margin: 10px 0; }

        /* --- æ’ç­è¡¨æ§åˆ¶å€ --- */
        .roster-header { background: white; padding: 15px; border-radius: 8px 8px 0 0; display: flex; flex-wrap: wrap; gap: 15px; align-items: center; border-bottom: 1px solid #eee; }
        
        /* è¦–åœ–åˆ‡æ› Tabs */
        .view-tabs { display: flex; background: #eee; padding: 3px; border-radius: 5px; }
        .view-tab { padding: 8px 15px; cursor: pointer; border-radius: 4px; border: none; background: transparent; font-weight: bold; color: #666; }
        .view-tab.active { background: white; color: var(--secondary-color); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

        .table-wrapper { flex: 1; overflow: auto; background: white; border: 1px solid #ddd; border-top: none; border-radius: 0 0 8px 8px; position: relative; }
        
        /* --- é€šç”¨è¡¨æ ¼æ¨£å¼ --- */
        table { border-collapse: separate; border-spacing: 0; font-size: 13px; min-width: 100%; }
        th, td { border-bottom: 1px solid #eee; border-right: 1px solid #eee; padding: 6px; text-align: center; vertical-align: middle; white-space: nowrap; height: 35px; }
        
        /* å‡çµçª—æ ¼ */
        thead { position: sticky; top: 0; z-index: 30; background: #fff; }
        .sticky-col { position: sticky; z-index: 20; background-color: #f8f9fa; border-right: 2px solid #ccc !important; }
        .col-name { left: 0; min-width: 80px; }
        .col-sch { left: 80px; min-width: 100px; }
        thead th.sticky-col { z-index: 40; background-color: var(--primary-color); color: white; }

        /* é¡è‰²ç‹€æ…‹ */
        .school-holiday { background-color: #d4edda !important; color: #155724; font-weight: bold; cursor: pointer; }
        .on-leave { background-color: #f8d7da !important; color: #721c24; font-weight: bold; cursor: pointer; }
        .weekend { background-color: #fafafa; color: #ccc; }
        .ph-cell { background-color: #fff3e0; color: #d35400; font-weight: bold; font-size: 11px; }
        
        /* å…¨å¹´è¦–åœ–å°ˆç”¨å¾®èª¿ */
        .yearly-view th, .yearly-view td { padding: 2px; font-size: 11px; height: 25px; }
        .yearly-view .ph-cell { writing-mode: vertical-lr; padding: 2px 0; }
        .month-divider { border-right: 2px solid #333 !important; }

        /* è­¦å‘Šæ¡† */
        #alert-area { background: #fff3cd; color: #856404; padding: 10px; margin-bottom: 10px; border-radius: 5px; display: none; font-size: 0.9em; }

        /* è¼¸å…¥æ¡†æ¨£å¼ */
        input, select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .btn { padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; color: white; }
        .btn-primary { background-color: var(--secondary-color); }
        .btn-danger { background-color: var(--accent-color); }
        .emp-table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; }
        .emp-table th { background: var(--primary-color); color: white; text-align: left; padding: 10px; }
        .emp-table td { padding: 10px; text-align: left; border-bottom: 1px solid #eee; }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2>ğŸ§¹ æ¸…æ½”å…¬å¸ HR</h2>
        <div class="menu-item active" onclick="showSection('dashboard')">ğŸ“Š å„€è¡¨æ¿</div>
        <div class="menu-item" onclick="showSection('roster')">ğŸ—“ï¸ æ’ç­ & ä¼‘å‡ç®¡ç†</div>
        <div class="menu-item" onclick="showSection('employees')">ğŸ‘¥ å“¡å·¥è³‡æ–™</div>
        <div class="menu-item" onclick="resetSystem()" style="margin-top: auto; background:#c0392b;">âš ï¸ é‡ç½®ç³»çµ±</div>
    </div>

    <div class="main-content">
        
        <div id="dashboard" class="section active">
            <h2 style="color: var(--primary-color);">ç³»çµ±æ¦‚è¦½</h2>
            <div class="card-container">
                <div class="card">
                    <h3 id="dash-total">0</h3><p>å“¡å·¥ç¸½æ•¸</p>
                </div>
                <div class="card">
                    <h3 id="dash-leave">0</h3><p>ä»Šæ—¥ä¼‘å‡</p>
                </div>
                <div class="card">
                    <h3 id="dash-remain">0</h3><p>å¹³å‡å‰©é¤˜å¹´å‡</p>
                </div>
            </div>
            <div style="background:white; padding:20px; border-radius:8px;">
                <h3>ğŸ‘‹ æ“ä½œæŒ‡å—</h3>
                <p>1. è«‹åˆ° <strong>ã€Œå“¡å·¥è³‡æ–™ã€</strong> å»ºç«‹æ‚¨çš„ 70 ä½å“¡å·¥åå–®ã€‚</p>
                <p>2. åˆ° <strong>ã€Œæ’ç­ & ä¼‘å‡ç®¡ç†ã€</strong>ï¼Œå¯åˆ‡æ› <strong>ã€Œæœˆåº¦ã€</strong> æˆ– <strong>ã€Œå…¨å¹´ã€</strong> è¦–åœ–ã€‚</p>
                <p>3. <strong>ç¶ è‰²</strong>ä»£è¡¨å­¸æ ¡å‡æœŸï¼ˆé©åˆæ”¾å‡ï¼‰ï¼Œ<strong>ç´…è‰²</strong>ä»£è¡¨å“¡å·¥å·²è«‹å‡ã€‚</p>
            </div>
        </div>

        <div id="roster" class="section">
            <div class="roster-header">
                <div class="view-tabs">
                    <button class="view-tab active" id="tab-month" onclick="switchView('month')">ğŸ“… æœˆåº¦ç´°ç¯€</button>
                    <button class="view-tab" id="tab-year" onclick="switchView('year')">ğŸ—“ï¸ å…¨å¹´ç¸½è¦½</button>
                </div>

                <div style="display:flex; gap:10px; align-items:center;">
                    <label>æ“ä½œï¼š</label>
                    <select id="modeSelect" style="font-weight:bold; border:2px solid var(--secondary-color);">
                        <option value="leave">æ’å“¡å·¥å¹´å‡ (é»æ“Š)</option>
                        <option value="holiday">è¨­å®šå­¸æ ¡å‡æœŸ (è¨­å®š)</option>
                    </select>
                </div>

                <div id="month-selector-group">
                    <select id="monthSelect" onchange="renderRoster()">
                        <option value="1">1æœˆ</option><option value="2">2æœˆ</option><option value="3">3æœˆ</option>
                        <option value="4">4æœˆ</option><option value="5">5æœˆ</option><option value="6">6æœˆ</option>
                        <option value="7">7æœˆ</option><option value="8">8æœˆ</option><option value="9">9æœˆ</option>
                        <option value="10">10æœˆ</option><option value="11" selected>11æœˆ</option><option value="12">12æœˆ</option>
                    </select>
                </div>

                <div style="margin-left:auto; font-size:12px; color:#666;">
                    <span style="background:#d4edda; padding:2px 5px;">ç¶ :æ ¡å‡</span>
                    <span style="background:#f8d7da; padding:2px 5px;">ç´…:è«‹å‡</span>
                    <span style="background:#fff3e0; padding:2px 5px;">æ©™:å…¬çœ¾å‡</span>
                </div>
            </div>

            <div id="alert-area"></div>

            <div class="table-wrapper">
                <table id="rosterTable">
                    <thead></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div id="employees" class="section">
            <h2 style="color: var(--primary-color);">å“¡å·¥è³‡æ–™ç®¡ç†</h2>
            <div style="background:white; padding:15px; margin-bottom:15px; border-radius:8px; display:flex; gap:10px;">
                <input type="text" id="new-name" placeholder="å§“å" style="flex:1">
                <input type="text" id="new-school" placeholder="å­¸æ ¡" style="flex:1">
                <input type="number" id="new-total" placeholder="å¹´å‡é¡" value="12" style="width:80px">
                <button class="btn btn-primary" onclick="addEmployee()">æ–°å¢</button>
            </div>
            <table class="emp-table">
                <thead>
                    <tr><th>å§“å</th><th>å­¸æ ¡</th><th>ç¸½é¡</th><th>å·²ç”¨</th><th>å‰©é¤˜</th><th>æ“ä½œ</th></tr>
                </thead>
                <tbody id="emp-list-body"></tbody>
            </table>
        </div>
    </div>

<script>
    // Firebase è¨­å®š
const firebaseConfig = {
    apiKey: "AIzaSyDuVyo0MVpQ8XJMYpLRQcj2kJ4_bdrVhGs",
    authDomain: "hr-system-58d4d.firebaseapp.com",
    projectId: "hr-system-58d4d",
    storageBucket: "hr-system-58d4d.firebasestorage.app",
    messagingSenderId: "841414140594",
    appId: "1:841414140594:web:07059f6863379d18a55fab"
};

// åˆå§‹åŒ– Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

    // --- 1. è³‡æ–™å­˜å– ---
    const KEY_EMP = 'hr_v4_emp';
    const KEY_SCH = 'hr_v4_sch';
    const currentYear = 2025;

    // é è¨­è³‡æ–™
    const defaultEmps = [
        { id: "E1", name: "é™³å¤§æ–‡", school: "è–ä¿ç¾…", total: 14, leaves: {} },
        { id: "E2", name: "æé˜¿å§¨", school: "è–ä¿ç¾…", total: 7, leaves: {} },
        { id: "E3", name: "å¼µå”å”", school: "åŸ¹æ­£", total: 10, leaves: {} }
    ];
    const defaultSch = { "è–ä¿ç¾…": {11:{5:"æ¸¬é©—",6:"æ¸¬é©—"}}, "åŸ¹æ­£": {12:{20:"è–èª•"}} };
    const publicHolidays = {
        1: {1:"å…ƒæ—¦", 29:"åˆä¸€", 30:"åˆäºŒ", 31:"åˆä¸‰"},
        4: {4:"æ¸…æ˜", 18:"å—é›£", 19:"ç¿Œæ—¥", 21:"å¾©æ´»"},
        5: {1:"å‹å‹•", 5:"ä½›èª•"}, 6: {30:"ç«¯åˆ"}, 7: {1:"å›æ­¸"},
        10: {1:"åœ‹æ…¶", 7:"é‡é™½", 29:"ä¸­ç§‹"}, 12: {25:"è–èª•", 26:"æ‹†ç¦®"}
    };

    let employees = JSON.parse(localStorage.getItem(KEY_EMP)) || defaultEmps;
    let schoolHolidays = JSON.parse(localStorage.getItem(KEY_SCH)) || defaultSch;
    let currentView = 'month'; // 'month' or 'year'

    // --- 2. åˆå§‹åŒ– ---
    window.onload = () => { loadData(); };

// å„²å­˜æ•¸æ“šåˆ° Firebase
async function saveData() {
    try {
        await db.collection('hrData2').doc('employees').set({ data: employees });
        await db.collection('hrData2').doc('schoolHolidays').set({ data: schoolHolidays });
        renderAll();
        console.log('æ•¸æ“šå·²åŒæ­¥åˆ° Firebase');
    } catch (error) {
        console.error('å„²å­˜æ•¸æ“šéŒ¯èª¤:', error);
        // å›é€€åˆ° localStorage
        localStorage.setItem(KEY_EMP, JSON.stringify(employees));
        localStorage.setItem(KEY_SCH, JSON.stringify(schoolHolidays));
        renderAll();
    }
}

    // å¾ Firebase è®€å–æ•¸æ“š
async function loadData() {
    try {
        const empDoc = await db.collection('hrData2').doc('employees').get();
        const schDoc = await db.collection('hrData2').doc('schoolHolidays').get();
        
        if (empDoc.exists) {
            employees = empDoc.data().data || defaultEmps;
        }
        if (schDoc.exists) {
            schoolHolidays = schDoc.data().data || defaultSch;
        }
        renderAll();
        console.log('å¾ Firebase è®€å–æ•¸æ“šæˆåŠŸ');
    } catch (error) {
        console.error('è®€å–æ•¸æ“šéŒ¯èª¤:', error);
        // å›é€€åˆ° localStorage
        employees = JSON.parse(localStorage.getItem(KEY_EMP)) || defaultEmps;
        schoolHolidays = JSON.parse(localStorage.getItem(KEY_SCH)) || defaultSch;
        renderAll();
    }
}

    function renderAll() {
        renderDashboard();
        renderRoster();
        renderEmployeeList();
    }

    function showSection(id) {
        document.querySelectorAll('.section').forEach(d => d.classList.remove('active'));
        document.querySelectorAll('.menu-item').forEach(d => d.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        
        // å´é‚Šæ¬„é«˜äº®
        const mapping = {'dashboard':0, 'roster':1, 'employees':2};
        if(mapping[id] !== undefined) document.querySelectorAll('.menu-item')[mapping[id]].classList.add('active');
        
        if(id === 'roster') renderRoster();
    }

    // --- 3. æ’ç­è¡¨é‚è¼¯ (é›™æ¨¡å¼) ---
    function switchView(view) {
        currentView = view;
        document.getElementById('tab-month').classList.toggle('active', view === 'month');
        document.getElementById('tab-year').classList.toggle('active', view === 'year');
        
        // æœˆåº¦é¸æ“‡å™¨åªåœ¨æœˆåº¦æ¨¡å¼é¡¯ç¤º
        document.getElementById('month-selector-group').style.display = (view === 'month') ? 'block' : 'none';
        
        // åˆ‡æ›CSS classä»¥èª¿æ•´æ ¼å­å¤§å°
        const table = document.getElementById('rosterTable');
        if(view === 'year') table.classList.add('yearly-view');
        else table.classList.remove('yearly-view');

        renderRoster();
    }

    function renderRoster() {
        if(currentView === 'month') renderMonthlyView();
        else renderYearlyView();
    }

    // A. æœˆåº¦è¦–åœ–æ¸²æŸ“
    function renderMonthlyView() {
        const month = parseInt(document.getElementById('monthSelect').value);
        const daysInMonth = new Date(currentYear, month, 0).getDate();
        const thead = document.querySelector('#rosterTable thead');
        const tbody = document.querySelector('#rosterTable tbody');
        document.getElementById('alert-area').style.display = 'none';

        // è¡¨é ­
        let h1 = `<tr><th class="sticky-col col-name" rowspan="2">å§“å</th><th class="sticky-col col-sch" rowspan="2">å­¸æ ¡</th><th rowspan="2" style="width:50px">é¤˜é¡</th>`;
        let h2 = `<tr>`;

        for(let d=1; d<=daysInMonth; d++) {
            let date = new Date(currentYear, month-1, d);
            let dayName = date.toLocaleDateString('zh-HK',{weekday:'narrow'});
            let color = (dayName==='å…­'||dayName==='æ—¥')?'#e74c3c':'#2c3e50';
            
            h1 += `<th style="color:${color}">${d}<br><small>${dayName}</small></th>`;
            
            let ph = (publicHolidays[month] && publicHolidays[month][d]) || "";
            h2 += `<th class="ph-cell">${ph}</th>`;
        }
        h1 += `</tr>`; h2 += `</tr>`;
        thead.innerHTML = h1 + h2;

        // å…§å®¹
        let body = "";
        let dailyConflict = {}; // åµæ¸¬è¡çªç”¨

        employees.forEach((emp, idx) => {
            let used = getUsedLeaves(emp);
            let remaining = emp.total - used;
            
            body += `<tr>
                <td class="sticky-col col-name">${emp.name}</td>
                <td class="sticky-col col-sch">${emp.school}</td>
                <td style="font-weight:bold; color:${remaining<0?'red':'green'}">${remaining}</td>`;
            
            for(let d=1; d<=daysInMonth; d++) {
                let cellData = getCellData(emp, month, d);
                body += `<td class="${cellData.cls}" style="${cellData.style}" onclick="handleCell(${idx},${month},${d})">${cellData.txt}</td>`;
                
                // è¡çªåµæ¸¬é‚è¼¯ï¼šä¸Šèª²æ—¥(éé€±æœ« éæ ¡å‡ éå…¬çœ¾å‡) æœ‰äººè«‹å‡
                if(cellData.isLeave && !cellData.isSchoolHol && !cellData.isPH && !cellData.isWeekend) {
                    let k = `${month}/${d}`;
                    if(!dailyConflict[k]) dailyConflict[k] = {};
                    if(!dailyConflict[k][emp.school]) dailyConflict[k][emp.school] = 0;
                    dailyConflict[k][emp.school]++;
                }
            }
            body += `</tr>`;
        });
        tbody.innerHTML = body;

        // é¡¯ç¤ºè¡çª
        let alerts = [];
        for(let date in dailyConflict) {
            for(let sch in dailyConflict[date]) {
                if(dailyConflict[date][sch] >= 1) { // é–¾å€¼: 1äººè«‹å‡å°±è­¦å‘Š(å¯æ”¹)
                    alerts.push(`âš ï¸ <strong>${date} (${sch})</strong>: æœ‰ ${dailyConflict[date][sch]} ä½å“¡å·¥åœ¨ã€Œä¸Šèª²æ—¥ã€è«‹å‡ï¼`);
                }
            }
        }
        if(alerts.length > 0) {
            const area = document.getElementById('alert-area');
            area.innerHTML = alerts.join('<br>');
            area.style.display = 'block';
        }
    }

    // B. å…¨å¹´è¦–åœ–æ¸²æŸ“
    function renderYearlyView() {
        const thead = document.querySelector('#rosterTable thead');
        const tbody = document.querySelector('#rosterTable tbody');
        document.getElementById('alert-area').style.display = 'none';

        // è¡¨é ­
        let h1 = `<tr><th class="sticky-col col-name">å§“å</th><th class="sticky-col col-sch">å­¸æ ¡</th>`;
        for(let m=1; m<=12; m++) {
            let days = new Date(currentYear, m, 0).getDate();
            for(let d=1; d<=days; d++) {
                let border = (d===days)?'month-divider':'';
                // é€™è£¡ç°¡åŒ–è¡¨é ­ï¼Œåªé¡¯ç¤ºæœˆä»½åˆ†éš”
                if(d===1) h1 += `<th colspan="${days}" class="month-divider" style="background:#eee;">${m}æœˆ</th>`;
            }
        }
        h1 += `</tr><tr><th class="sticky-col col-name" style="top:35px"></th><th class="sticky-col col-sch" style="top:35px"></th>`; // ç¬¬äºŒè¡Œè¡¨é ­ä½”ä½
        
        // æ—¥æœŸè¡Œ
        for(let m=1; m<=12; m++) {
            let days = new Date(currentYear, m, 0).getDate();
            for(let d=1; d<=days; d++) {
                let border = (d===days)?'month-divider':'';
                let date = new Date(currentYear, m-1, d);
                let dayName = date.toLocaleDateString('zh-HK',{weekday:'narrow'});
                let color = (dayName==='å…­'||dayName==='æ—¥')?'#e74c3c':'#2c3e50';
                h1 += `<th class="${border}" style="color:${color}; top:35px;">${d}</th>`;
            }
        }
        h1 += `</tr>`;
        thead.innerHTML = h1;

        // å…§å®¹
        let body = "";
        employees.forEach((emp, idx) => {
            let used = getUsedLeaves(emp);
            let remaining = emp.total - used;
            let remainInfo = remaining < 0 ? `(è¶…${Math.abs(remaining)})` : `(é¤˜${remaining})`;

            body += `<tr>
                <td class="sticky-col col-name">${emp.name} <span style="font-size:10px">${remainInfo}</span></td>
                <td class="sticky-col col-sch">${emp.school}</td>`;
            
            for(let m=1; m<=12; m++) {
                let days = new Date(currentYear, m, 0).getDate();
                for(let d=1; d<=days; d++) {
                    let cellData = getCellData(emp, m, d, true); // true for compact
                    let border = (d===days)?'month-divider':'';
                    body += `<td class="${cellData.cls} ${border}" title="${cellData.txt}" onclick="handleCell(${idx},${m},${d})"></td>`; 
                    // å…¨å¹´è¦–åœ–ä¸é¡¯ç¤ºæ–‡å­—ï¼Œåªé¡¯ç¤ºé¡è‰²å¡Š
                }
            }
            body += `</tr>`;
        });
        tbody.innerHTML = body;
    }

    // è¼”åŠ©ï¼šè¨ˆç®—å–®æ ¼ç‹€æ…‹
    function getCellData(emp, m, d, isCompact=false) {
        let date = new Date(currentYear, m-1, d);
        let dayWeek = date.getDay();
        let isWeekend = (dayWeek===0 || dayWeek===6);
        
        let isLeave = (emp.leaves[m] && emp.leaves[m].includes(d));
        let schoolHolName = (schoolHolidays[emp.school] && schoolHolidays[emp.school][m] && schoolHolidays[emp.school][m][d]);
        let phName = (publicHolidays[m] && publicHolidays[m][d]);

        let cls = isWeekend ? "weekend" : "";
        let txt = "";
        let style = "";

        if(isLeave) {
            cls = "on-leave";
            txt = "ä¼‘";
        } else if(schoolHolName) {
            cls = "school-holiday";
            txt = isCompact ? schoolHolName : schoolHolName;
        } else if(phName) {
            style = "background:#fff3e0"; // æ©™è‰²åº•
            // å¦‚æœæ˜¯æœˆåº¦è¦–åœ–ï¼Œä¸é¡¯ç¤ºæ–‡å­—(è¡¨é ­å·²æœ‰)ï¼Œå¦‚æœæ˜¯å…¨å¹´ï¼Œä¸é¡¯ç¤º
        }

        return { cls, txt, style, isLeave, isSchoolHol: !!schoolHolName, isPH: !!phName, isWeekend };
    }

    function getUsedLeaves(emp) {
        let count = 0;
        for(let m in emp.leaves) count += emp.leaves[m].length;
        return count;
    }

    // --- 4. é»æ“Šè™•ç† ---
    function handleCell(empIdx, m, d) {
        let mode = document.getElementById('modeSelect').value;
        let emp = employees[empIdx];

        if(mode === 'leave') {
            if(!emp.leaves[m]) emp.leaves[m] = [];
            if(emp.leaves[m].includes(d)) {
                emp.leaves[m] = emp.leaves[m].filter(x => x!==d);
            } else {
                emp.leaves[m].push(d);
            }
            saveData();
        } else {
            // è¨­å®šå­¸æ ¡å‡æœŸ
            let sch = emp.school;
            if(!schoolHolidays[sch]) schoolHolidays[sch] = {};
            if(!schoolHolidays[sch][m]) schoolHolidays[sch][m] = {};

            if(schoolHolidays[sch][m][d]) {
                if(confirm(`åˆªé™¤ ${sch} ${m}/${d} çš„å‡æœŸ?`)) delete schoolHolidays[sch][m][d];
            } else {
                let n = prompt(`è¼¸å…¥ ${sch} ${m}/${d} å‡æœŸå:`);
                if(n) schoolHolidays[sch][m][d] = n;
            }
            saveData();
        }
    }

    // --- 5. å…¶ä»–åŠŸèƒ½ ---
    function renderDashboard() {
        document.getElementById('dash-total').innerText = employees.length;
        let today = new Date();
        let m = today.getMonth()+1, d = today.getDate();
        let count = employees.filter(e => e.leaves[m] && e.leaves[m].includes(d)).length;
        document.getElementById('dash-leave').innerText = count;
        
        let totalRem = employees.reduce((acc, e) => acc + (e.total - getUsedLeaves(e)), 0);
        let avg = employees.length ? (totalRem/employees.length).toFixed(1) : 0;
        document.getElementById('dash-remain').innerText = avg;
    }

    function renderEmployeeList() {
        const tbody = document.getElementById('emp-list-body');
        tbody.innerHTML = '';
        employees.forEach((emp, idx) => {
            let used = getUsedLeaves(emp);
            tbody.innerHTML += `<tr>
                <td>${emp.name}</td><td>${emp.school}</td><td>${emp.total}</td>
                <td>${used}</td><td>${emp.total-used}</td>
                <td><button class="btn btn-danger" onclick="delEmp(${idx})">åˆªé™¤</button></td>
            </tr>`;
        });
    }

    function addEmployee() {
        let name = document.getElementById('new-name').value;
        let sch = document.getElementById('new-school').value;
        let tot = parseInt(document.getElementById('new-total').value);
        if(name && sch) {
            employees.push({id:Date.now(), name:name, school:sch, total:tot, leaves:{}});
            saveData();
            document.getElementById('new-name').value = '';
        }
    }

    function delEmp(idx) {
        if(confirm('ç¢ºå®šåˆªé™¤?')) { employees.splice(idx,1); saveData(); }
    }

    function resetSystem() {
        if(confirm('é‡ç½®æ‰€æœ‰æ•¸æ“š?')) { localStorage.clear(); location.reload(); }
    }
</script>
</body>
</html>
